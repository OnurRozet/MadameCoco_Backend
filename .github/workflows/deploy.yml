name: CI/CD Pipeline - MadameCoco Microservices

on:
  push:
    branches:
      - main # Ana dala yapılan her değişiklikte tetikle

env:
  DOCKER_REPO: ${{ secrets.DOCKER_USERNAME }}/madamecoco
  
jobs:
  # 1. Aşama: Test ve İmaj Oluşturma/Gönderme
  build_test_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Repository içeriğini okumak için
      checks: write    # Test sonuçlarını check run olarak yayınlamak için
      pull-requests: write  # PR'lara yorum yazmak için
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x' # Projenizin .NET sürümünü kontrol edin

      # 💡 Testleri Çalıştır (Unit + Integration)
      - name: Run Customer Tests
        id: customer_tests
        run: |
          dotnet test Customer/MadameCoco.Customer.Tests/MadameCoco.Customer.Tests.csproj \
            --logger "trx;LogFileName=CustomerTests.trx" \
            --results-directory "${{ github.workspace }}/TestResults/Customer" \
            --collect:"XPlat Code Coverage" \
            --verbosity normal
        continue-on-error: false

      - name: Run Order Tests
        id: order_tests
        run: |
          dotnet test Order/MadameCoco.Order.Tests/MadameCoco.Order.Tests.csproj \
            --logger "trx;LogFileName=OrderTests.trx" \
            --results-directory "${{ github.workspace }}/TestResults/Order" \
            --collect:"XPlat Code Coverage" \
            --verbosity normal
        continue-on-error: false

      # Test sonuçlarını yayınla
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          trx_files: |
            TestResults/Customer/**/*.trx
            TestResults/Order/**/*.trx
          check_name: 'Test Results'
          comment_mode: 'always'
          report_individual_runs: true
          
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      # --- Tüm Servisleri Oluştur ve Docker Hub'a Gönder (Push) ---
      
      # Customer.API
      - name: Build and Push Customer.API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Customer/MadameCoco.Customer.API/Dockerfile
          push: true
          tags: ${{ env.DOCKER_REPO }}-customer-api:latest

      # Order.API
      - name: Build and Push Order.API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Order/MadameCoco.Order.API/Dockerfile
          push: true
          tags: ${{ env.DOCKER_REPO }}-order-api:latest
          
      # Audit.Worker
      - name: Build and Push Audit.Worker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Audit/MadameCoco.Audit.Worker/Dockerfile
          push: true
          tags: ${{ env.DOCKER_REPO }}-audit-worker:latest
          
      # Gateway
      - name: Build and Push Gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ApiGateways/MadameCoco.Gateway/Dockerfile
          push: true
          tags: ${{ env.DOCKER_REPO }}-gateway:latest


  # 2. Aşama: Sanal Dağıtım (Continuous Deployment)
  deploy_to_prod:
    needs: build_test_push # Önceki aşama başarılı olursa çalıştır
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH (Simulated)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Sunucuda çalışacak komutlar
          script: |
            echo "Dağıtım süreci başlatılıyor..."
            
            # --- Sunucu Ortamının Simülasyonu ---
            # 1. Proje klasörüne git
            cd /var/www/madamecoco-prod
            
            # 2. Yeni imajları Container Registry'den (Docker Hub) çek
            echo "Yeni Docker imajları çekiliyor: docker compose pull"
            docker compose pull
            
            # 3. Servisleri yeniden başlat ve eski konteynerleri temizle
            echo "Servisler yeniden başlatılıyor: docker compose up -d"
            docker compose up -d --remove-orphans 
            
            echo "CI/CD Başarıyla Tamamlandı: Kod, ${deployment_user} tarafından canlı ortama gönderildi."
            # -------------------------------------